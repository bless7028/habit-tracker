<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>ë£¨í‹´ ë„ì¥ ğŸŒ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #fff8f5;
    --surface: #ffffff;
    --surface2: #fff0f5;
    --border: #ffd6e7;
    --pink: #ff85b3;
    --pink-light: #ffc2d9;
    --purple: #b392f0;
    --purple-light: #e8dcff;
    --peach: #ffb347;
    --mint: #5ecf9e;
    --mint-light: #c8f5e3;
    --sky: #74c0fc;
    --sky-light: #d0ebff;
    --yellow: #ffe066;
    --text: #4a3f5c;
    --muted: #c8b0cc;
    --shadow: rgba(255,133,179,0.13);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Jua', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    max-width: 430px;
    margin: 0 auto;
    overflow-x: hidden;
    background-image:
      radial-gradient(circle at 15% 15%, rgba(255,133,179,0.07) 0%, transparent 50%),
      radial-gradient(circle at 85% 75%, rgba(179,146,240,0.07) 0%, transparent 50%);
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    padding: 52px 22px 16px;
    position: relative;
  }
  .date-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 30px;
    padding: 4px 14px;
    font-size: 12px;
    color: var(--pink);
    margin-bottom: 10px;
    font-family: 'Gaegu', cursive;
    font-weight: 700;
  }
  .header-title {
    font-family: 'Jua', sans-serif;
    font-size: 25px;
    line-height: 1.3;
    color: var(--text);
  }
  .header-title .hl {
    color: var(--pink);
    position: relative;
    display: inline-block;
  }
  .header-title .hl::after {
    content: '';
    position: absolute;
    left: 0; bottom: 0;
    width: 100%; height: 5px;
    background: var(--yellow);
    border-radius: 4px;
    z-index: -1;
    opacity: 0.7;
  }
  .progress-wrap {
    margin-top: 14px;
    background: var(--border);
    border-radius: 20px;
    height: 10px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--pink), var(--purple));
    border-radius: 20px;
    transition: width 0.6s cubic-bezier(.4,2,.4,1);
    width: 0%;
  }
  .progress-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 6px;
    font-size: 12px;
    color: var(--muted);
    font-family: 'Gaegu', cursive;
    font-weight: 700;
  }
  .progress-label strong { color: var(--pink); font-size: 14px; }

  /* â”€â”€ Nav â”€â”€ */
  .nav {
    display: flex;
    margin: 4px 20px 16px;
    background: var(--surface);
    border-radius: 20px;
    padding: 5px;
    border: 2px solid var(--border);
    box-shadow: 0 4px 14px var(--shadow);
  }
  .nav button {
    flex: 1;
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Jua', sans-serif;
    font-size: 13px;
    padding: 10px 0;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.25s;
  }
  .nav button.active {
    background: linear-gradient(135deg, var(--pink), var(--purple));
    color: #fff;
    box-shadow: 0 4px 12px rgba(255,133,179,0.35);
  }

  /* â”€â”€ Views â”€â”€ */
  .view { display: none; padding: 0 20px 110px; }
  .view.active { display: block; }

  /* â”€â”€ Habit Cards â”€â”€ */
  .habit-list { display: flex; flex-direction: column; gap: 12px; }

  .habit-card {
    background: var(--surface);
    border-radius: 22px;
    border: 2px solid var(--border);
    padding: 14px 14px 14px 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    -webkit-user-select: none; user-select: none;
    transition: transform 0.15s, box-shadow 0.2s, border-color 0.3s;
    box-shadow: 0 3px 12px var(--shadow);
    position: relative;
    overflow: hidden;
  }
  .habit-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 5px;
    border-radius: 4px 0 0 4px;
    background: var(--border);
    transition: background 0.3s;
  }
  .habit-card:active { transform: scale(0.96); }
  .habit-card.done {
    border-color: var(--pink-light);
    background: linear-gradient(135deg, #fff5f9 0%, #f8f0ff 100%);
  }
  .habit-card.done::before {
    background: linear-gradient(180deg, var(--pink), var(--purple));
  }

  /* Stamp icon */
  .stamp-wrap { width: 52px; height: 52px; flex-shrink: 0; position: relative; }
  .stamp-bg {
    width: 52px; height: 52px;
    border-radius: 16px;
    border: 2px solid var(--border);
    background: var(--surface2);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px;
    transition: all 0.35s cubic-bezier(.4,2,.4,1);
    position: relative;
    overflow: hidden;
  }
  .habit-card.done .stamp-bg {
    border-color: var(--pink-light);
    background: linear-gradient(135deg, #ffd6eb, #e8d5ff);
    box-shadow: 0 4px 14px rgba(255,133,179,0.25);
    animation: bouncePop 0.45s cubic-bezier(.4,2.2,.4,1) forwards;
  }
  @keyframes bouncePop {
    0% { transform: scale(1) rotate(0); }
    35% { transform: scale(1.3) rotate(-12deg); }
    65% { transform: scale(0.95) rotate(5deg); }
    100% { transform: scale(1) rotate(0); }
  }
  .stamp-check {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    opacity: 0;
    transition: opacity 0.25s;
    background: linear-gradient(135deg, rgba(255,204,229,0.88), rgba(232,213,255,0.88));
    border-radius: 14px;
  }
  .habit-card.done .stamp-check { opacity: 1; }

  /* Info */
  .habit-info { flex: 1; min-width: 0; }
  .habit-name {
    font-family: 'Jua', sans-serif;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
    transition: color 0.3s;
  }
  .habit-card.done .habit-name { color: var(--pink); }
  .habit-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-top: 5px; }
  .time-badge {
    display: inline-flex; align-items: center; gap: 3px;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 11px; color: var(--muted);
    font-family: 'Gaegu', cursive; font-weight: 700;
  }
  .habit-card.done .time-badge { border-color: var(--pink-light); color: var(--pink); }
  .status-tag {
    display: inline-flex; align-items: center; gap: 3px;
    border-radius: 10px; padding: 2px 8px;
    font-size: 11px; font-family: 'Gaegu', cursive; font-weight: 700;
  }
  .status-tag.upcoming { background: var(--sky-light); color: var(--sky); }
  .status-tag.now { background: #fff3cd; color: var(--peach); }
  .status-tag.past { background: #f4f4f4; color: #bbb; }
  .status-tag.done-label { background: var(--mint-light); color: var(--mint); }
  .streak-badge {
    font-size: 11px; color: var(--peach);
    font-family: 'Gaegu', cursive; font-weight: 700;
    margin-top: 3px;
  }

  .habit-actions { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
  .btn-icon {
    background: none; border: none; cursor: pointer;
    font-size: 15px; width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 10px; transition: background 0.2s;
  }
  .btn-icon:hover { background: var(--surface2); }

  /* â”€â”€ Section label â”€â”€ */
  .section-label {
    font-family: 'Gaegu', cursive; font-weight: 700;
    font-size: 13px; color: var(--muted);
    margin: 18px 0 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-label::after { content:''; flex:1; height:1.5px; background:var(--border); border-radius:2px; }

  /* â”€â”€ Empty state â”€â”€ */
  .empty-state { text-align: center; padding: 50px 20px; color: var(--muted); }
  .empty-state .big-emoji { font-size: 54px; margin-bottom: 12px; animation: float 2.5s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .empty-state p { font-size: 14px; line-height: 1.7; font-family:'Gaegu',cursive; font-weight:700; }

  /* â”€â”€ FAB â”€â”€ */
  .fab {
    position: fixed; bottom: 30px; right: 22px;
    width: 62px; height: 62px; border-radius: 50%;
    background: linear-gradient(135deg, var(--pink), var(--purple));
    border: none; color: #fff; font-size: 28px; cursor: pointer;
    box-shadow: 0 8px 24px rgba(255,133,179,0.45), 0 2px 8px rgba(0,0,0,0.07);
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s; z-index: 100;
  }
  .fab:active { transform: scale(0.9); }
  .fab-ring {
    position: fixed; bottom: 26px; right: 18px;
    width: 70px; height: 70px; border-radius: 50%;
    border: 2px solid var(--pink-light);
    z-index: 99; pointer-events: none;
    animation: pulse-ring 2.5s ease-in-out infinite;
  }
  @keyframes pulse-ring { 0%,100%{transform:scale(1);opacity:0.5} 50%{transform:scale(1.12);opacity:0.15} }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(74,63,92,0.3);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: flex; align-items: flex-end;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--bg);
    border-radius: 32px 32px 0 0;
    padding: 20px 22px 50px;
    width: 100%;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(.4,0,.2,1);
    border-top: 3px solid var(--border);
    max-height: 92vh;
    overflow-y: auto;
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 4px; margin: 0 auto 18px; }
  .modal h2 { font-family:'Jua'; font-size: 20px; margin-bottom: 18px; color: var(--text); }

  /* Form */
  .form-group { margin-bottom: 15px; }
  .form-group label {
    display: block; font-family:'Gaegu',cursive; font-weight:700;
    font-size: 13px; color: var(--muted); margin-bottom: 8px; padding-left: 4px;
  }
  .form-group input {
    width: 100%;
    background: var(--surface); border: 2px solid var(--border);
    border-radius: 16px; padding: 12px 16px;
    color: var(--text); font-family: 'Jua', sans-serif; font-size: 15px;
    outline: none; transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }
  .form-group input:focus { border-color: var(--pink); box-shadow: 0 0 0 3px rgba(255,133,179,0.12); }
  .emoji-grid { display: grid; grid-template-columns: repeat(8,1fr); gap: 6px; }
  .emoji-btn {
    aspect-ratio: 1; border-radius: 12px;
    border: 2px solid var(--border); background: var(--surface);
    font-size: 18px; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }
  .emoji-btn.selected {
    border-color: var(--pink); background: rgba(255,133,179,0.1);
    transform: scale(1.12); box-shadow: 0 4px 10px rgba(255,133,179,0.2);
  }
  .time-row { display: flex; gap: 8px; align-items: center; }
  .time-sep { font-family:'Jua'; color: var(--muted); font-size: 18px; }
  .days-row { display: flex; gap: 5px; }
  .day-btn {
    flex: 1; aspect-ratio: 1; border-radius: 12px;
    border: 2px solid var(--border); background: var(--surface);
    color: var(--muted); font-family:'Jua'; font-size: 13px; cursor: pointer; transition: all 0.2s;
  }
  .day-btn.selected {
    border-color: var(--pink);
    background: linear-gradient(135deg, rgba(255,133,179,0.12), rgba(179,146,240,0.12));
    color: var(--pink);
  }
  .btn-primary {
    width: 100%;
    background: linear-gradient(135deg, var(--pink), var(--purple));
    border: none; border-radius: 18px; padding: 16px;
    color: #fff; font-family:'Jua'; font-size: 17px; cursor: pointer;
    margin-top: 10px; transition: opacity 0.2s, transform 0.15s;
    box-shadow: 0 6px 18px rgba(255,133,179,0.35);
  }
  .btn-primary:active { transform: scale(0.97); opacity: 0.9; }

  /* â”€â”€ Calendar â”€â”€ */
  .cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
  .cal-header h2 { font-family:'Jua'; font-size:18px; }
  .cal-nav {
    background: var(--surface); border: 2px solid var(--border);
    border-radius: 12px; color: var(--pink); font-size: 18px;
    cursor: pointer; padding: 4px 12px; font-family:'Jua';
  }
  .cal-days-header {
    display: grid; grid-template-columns: repeat(7,1fr);
    text-align: center; font-size: 12px; color: var(--muted);
    margin-bottom: 8px; font-family:'Gaegu',cursive; font-weight:700;
  }
  .cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 3px; }
  .cal-cell {
    aspect-ratio: 1; display:flex; align-items:center; justify-content:center;
    border-radius: 50%; font-size: 13px; cursor: pointer;
    font-family:'Gaegu',cursive; font-weight:700; position:relative;
    transition: background 0.2s; color: var(--text);
  }
  .cal-cell.today { background: linear-gradient(135deg,var(--pink),var(--purple)); color:#fff; box-shadow:0 3px 10px rgba(255,133,179,0.35); }
  .cal-cell.full-stamp { background: rgba(255,133,179,0.12); border: 2px solid var(--pink-light); }
  .cal-cell.has-stamp::after {
    content:''; position:absolute; bottom:3px; left:50%; transform:translateX(-50%);
    width:4px; height:4px; border-radius:50%; background:var(--purple);
  }
  .cal-cell.other-month { color:var(--border); cursor:default; }
  .cal-cell:not(.today):not(.other-month):hover { background:var(--surface2); }

  /* â”€â”€ Stats â”€â”€ */
  .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:18px; }
  .stat-card {
    background:var(--surface); border:2px solid var(--border);
    border-radius:20px; padding:16px 12px; text-align:center;
    box-shadow:0 3px 10px var(--shadow);
  }
  .stat-card .val {
    font-family:'Jua'; font-size:34px;
    background: linear-gradient(135deg, var(--pink), var(--purple));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    line-height:1;
  }
  .stat-card .lbl { font-family:'Gaegu',cursive; font-weight:700; font-size:12px; color:var(--muted); margin-top:4px; }
  .habit-stat-row {
    background:var(--surface); border:2px solid var(--border); border-radius:18px;
    padding:12px 14px; display:flex; align-items:center; gap:10px;
    margin-bottom:10px; box-shadow:0 2px 8px var(--shadow);
  }
  .habit-stat-row .s-icon { font-size:24px; }
  .habit-stat-row .s-info { flex:1; }
  .habit-stat-row .s-name { font-family:'Jua'; font-size:14px; }
  .habit-stat-row .s-bar-wrap { height:5px; background:var(--border); border-radius:5px; margin-top:6px; overflow:hidden; }
  .habit-stat-row .s-bar { height:100%; background:linear-gradient(90deg,var(--pink),var(--purple)); border-radius:5px; transition:width 0.6s; }
  .habit-stat-row .s-pct { font-family:'Gaegu',cursive; font-weight:700; font-size:14px; color:var(--pink); }

  /* â”€â”€ Burst â”€â”€ */
  .burst { position:fixed; top:50%; left:50%; pointer-events:none; z-index:999; }
  .burst-p { position:absolute; font-size:16px; animation:burst-fly 0.8s ease-out forwards; }
  @keyframes burst-fly {
    from { transform:translate(-50%,-50%) scale(1); opacity:1; }
    to { transform:translate(var(--tx),var(--ty)) scale(0) rotate(var(--rot)); opacity:0; }
  }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position:fixed; bottom:108px; left:50%;
    transform:translateX(-50%) translateY(10px);
    background:var(--surface); border:2.5px solid var(--pink-light);
    border-radius:40px; padding:10px 22px;
    font-family:'Jua'; font-size:14px; color:var(--pink);
    opacity:0; pointer-events:none; transition:all 0.3s;
    white-space:nowrap; z-index:999;
    box-shadow:0 4px 16px rgba(255,133,179,0.2);
  }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  ::-webkit-scrollbar { width: 0; }
</style>
</head>
<body>

<div class="header">
  <div class="date-pill">ğŸŒ¸ <span id="headerDate">ì˜¤ëŠ˜</span></div>
  <div class="header-title">ì˜¤ëŠ˜ë„ <span class="hl">ë„ì¥</span> ì°ìœ¼ëŸ¬<br>ê°€ë³¼ê¹Œìš”? â˜ºï¸</div>
  <div class="progress-wrap">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <div class="progress-label">
    <span id="progressText">0 / 0 ì™„ë£Œ</span>
    <strong id="progressPct">0%</strong>
  </div>
</div>

<div class="nav">
  <button class="active" onclick="switchTab('today')">ğŸŒŸ ì˜¤ëŠ˜</button>
  <button onclick="switchTab('calendar')">ğŸ“… ë‹¬ë ¥</button>
  <button onclick="switchTab('stats')">ğŸ“Š í†µê³„</button>
</div>

<div class="view active" id="view-today">
  <div class="habit-list" id="habitList"></div>
</div>

<div class="view" id="view-calendar">
  <div class="cal-header">
    <button class="cal-nav" onclick="calNav(-1)">â€¹</button>
    <h2 id="calTitle"></h2>
    <button class="cal-nav" onclick="calNav(1)">â€º</button>
  </div>
  <div class="cal-days-header">
    <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
  </div>
  <div class="cal-grid" id="calGrid"></div>
  <div style="margin-top:14px;display:flex;gap:14px;font-size:12px;font-family:'Gaegu',cursive;font-weight:700;color:var(--muted);">
    <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;border-radius:50%;background:rgba(255,133,179,0.15);border:2px solid var(--pink-light);display:inline-block;"></span>ì¼ë¶€ ì™„ë£Œ</span>
    <span style="display:flex;align-items:center;gap:5px;"><span style="width:14px;height:14px;border-radius:50%;background:linear-gradient(135deg,var(--pink),var(--purple));display:inline-block;"></span>ì˜¤ëŠ˜</span>
  </div>
</div>

<div class="view" id="view-stats">
  <div class="stats-grid">
    <div class="stat-card"><div class="val" id="statTotal">0</div><div class="lbl">ğŸ–Šï¸ ì´ ë„ì¥ ìˆ˜</div></div>
    <div class="stat-card"><div class="val" id="statStreak">0</div><div class="lbl">ğŸ”¥ ìµœì¥ ì—°ì†</div></div>
    <div class="stat-card"><div class="val" id="statToday">0</div><div class="lbl">â­ ì˜¤ëŠ˜ ì™„ë£Œ</div></div>
    <div class="stat-card"><div class="val" id="statHabits">0</div><div class="lbl">ğŸŒ± ë“±ë¡ëœ ë£¨í‹´</div></div>
  </div>
  <div class="section-label">ë£¨í‹´ë³„ ë‹¬ì„±ë¥  (30ì¼)</div>
  <div id="statHabitList"></div>
</div>

<div class="fab-ring"></div>
<button class="fab" onclick="openModal()">ï¼‹</button>

<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>ğŸŒŸ ìƒˆ ë£¨í‹´ ë§Œë“¤ê¸°</h2>
    <div class="form-group">
      <label>ì´ëª¨ì§€ ì„ íƒ</label>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>
    <div class="form-group">
      <label>ë£¨í‹´ ì´ë¦„</label>
      <input type="text" id="inputName" placeholder="ì˜ˆ) ë¬¼ 2L ë§ˆì‹œê¸° ğŸ’§" maxlength="30">
    </div>
    <div class="form-group">
      <label>ëª©í‘œ ì‹œê°„ëŒ€</label>
      <div class="time-row">
        <input type="time" id="inputTimeFrom" value="07:00" style="flex:1">
        <span class="time-sep">~</span>
        <input type="time" id="inputTimeTo" value="08:00" style="flex:1">
      </div>
    </div>
    <div class="form-group">
      <label>ë°˜ë³µ ìš”ì¼</label>
      <div class="days-row" id="daysRow">
        <button class="day-btn selected" data-day="0">ì¼</button>
        <button class="day-btn selected" data-day="1">ì›”</button>
        <button class="day-btn selected" data-day="2">í™”</button>
        <button class="day-btn selected" data-day="3">ìˆ˜</button>
        <button class="day-btn selected" data-day="4">ëª©</button>
        <button class="day-btn selected" data-day="5">ê¸ˆ</button>
        <button class="day-btn selected" data-day="6">í† </button>
      </div>
    </div>
    <button class="btn-primary" onclick="saveHabit()">ğŸ–Šï¸ ë„ì¥ ì¶”ê°€í•˜ê¸°!</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const EMOJIS = ['ğŸ’ª','ğŸƒ','ğŸ“š','ğŸ’§','ğŸ§˜','ğŸ¥—','ğŸ¯','ğŸŒ…','âœï¸','ğŸµ','ğŸ§¹','ğŸ’Š','ğŸš´','ğŸ›ï¸','ğŸŒ¿','â˜•','ğŸ§ ','ğŸ¦·','â¤ï¸','ğŸ¨','ğŸ§´','ğŸ£','ğŸŒ™','â­'];
const today = new Date();
let habits = JSON.parse(localStorage.getItem('cute_habits') || '[]');
let completions = JSON.parse(localStorage.getItem('cute_completions') || '{}');
let selectedEmoji = EMOJIS[0];
let editingId = null;
let calYear = today.getFullYear(), calMonth = today.getMonth();

function todayKey() { return today.toISOString().slice(0,10); }
function dateKey(d) { return d.toISOString().slice(0,10); }
function save() {
  localStorage.setItem('cute_habits', JSON.stringify(habits));
  localStorage.setItem('cute_completions', JSON.stringify(completions));
}

function switchTab(tab) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + tab).classList.add('active');
  ['today','calendar','stats'].forEach((t,i) => {
    if (t === tab) document.querySelectorAll('.nav button')[i].classList.add('active');
  });
  if (tab === 'calendar') renderCalendar();
  if (tab === 'stats') renderStats();
}

function renderEmojiGrid() {
  const grid = document.getElementById('emojiGrid');
  grid.innerHTML = '';
  EMOJIS.forEach(e => {
    const btn = document.createElement('button');
    btn.className = 'emoji-btn' + (e === selectedEmoji ? ' selected' : '');
    btn.textContent = e;
    btn.onclick = () => { selectedEmoji = e; renderEmojiGrid(); };
    grid.appendChild(btn);
  });
}

document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', () => btn.classList.toggle('selected'));
});

function openModal(id = null) {
  editingId = id;
  selectedEmoji = EMOJIS[0];
  if (id !== null) {
    const h = habits.find(h => h.id === id);
    if (h) {
      selectedEmoji = h.emoji;
      document.getElementById('inputName').value = h.name;
      document.getElementById('inputTimeFrom').value = h.timeFrom;
      document.getElementById('inputTimeTo').value = h.timeTo;
      document.querySelectorAll('.day-btn').forEach(btn =>
        btn.classList.toggle('selected', h.days.includes(+btn.dataset.day))
      );
    }
  } else {
    document.getElementById('inputName').value = '';
    document.getElementById('inputTimeFrom').value = '07:00';
    document.getElementById('inputTimeTo').value = '08:00';
    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.add('selected'));
  }
  renderEmojiGrid();
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
function handleOverlayClick(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

function saveHabit() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { showToast('ë£¨í‹´ ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš” ğŸ¥º'); return; }
  const days = [...document.querySelectorAll('.day-btn.selected')].map(b => +b.dataset.day);
  if (!days.length) { showToast('ìš”ì¼ì„ í•˜ë‚˜ ì´ìƒ ê³¨ë¼ì£¼ì„¸ìš”!'); return; }
  const timeFrom = document.getElementById('inputTimeFrom').value;
  const timeTo = document.getElementById('inputTimeTo').value;
  if (editingId !== null) {
    const h = habits.find(h => h.id === editingId);
    if (h) Object.assign(h, { name, emoji: selectedEmoji, days, timeFrom, timeTo });
  } else {
    habits.push({ id: Date.now(), name, emoji: selectedEmoji, days, timeFrom, timeTo });
  }
  save(); closeModal(); renderToday();
  showToast(editingId !== null ? 'ìˆ˜ì •í–ˆì–´ìš” âœ¨' : 'ìƒˆ ë£¨í‹´ ì¶”ê°€! ğŸ‰');
  editingId = null;
}

function deleteHabit(id) {
  if (!confirm('ì´ ë£¨í‹´ì„ ì‚­ì œí• ê¹Œìš”? ğŸ¥²')) return;
  habits = habits.filter(h => h.id !== id);
  save(); renderToday(); showToast('ì‚­ì œí–ˆì–´ìš”!');
}

function getTimeStatus(timeFrom, timeTo) {
  const nowMin = today.getHours() * 60 + today.getMinutes();
  const [fh,fm] = timeFrom.split(':').map(Number);
  const [th,tm] = timeTo.split(':').map(Number);
  if (nowMin < fh*60+fm) return 'upcoming';
  if (nowMin <= th*60+tm) return 'now';
  return 'past';
}
const statusInfo = {
  upcoming: { cls:'upcoming', txt:'â° ì˜ˆì •' },
  now:      { cls:'now',      txt:'ğŸ”” ì§€ê¸ˆ!' },
  past:     { cls:'past',     txt:'ğŸ•“ ì§€ë‚œ' },
  'done-label': { cls:'done-label', txt:'âœ… ì™„ë£Œ' }
};

function renderToday() {
  const key = todayKey();
  const dow = today.getDay();
  const todayHabits = habits.filter(h => h.days.includes(dow));
  const opts = { year:'numeric', month:'long', day:'numeric', weekday:'long' };
  document.getElementById('headerDate').textContent = today.toLocaleDateString('ko-KR', opts);
  const done = todayHabits.filter(h => completions[key]?.includes(h.id)).length;
  const total = todayHabits.length;
  const pct = total ? Math.round(done/total*100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${done} / ${total} ì™„ë£Œ`;
  document.getElementById('progressPct').textContent = pct + '%';

  const list = document.getElementById('habitList');
  list.innerHTML = '';
  if (!todayHabits.length) {
    list.innerHTML = `<div class="empty-state"><div class="big-emoji">ğŸŒ±</div><p>ì˜¤ëŠ˜ í•  ë£¨í‹´ì´ ì—†ì–´ìš”~<br>ì•„ë˜ ï¼‹ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>`;
    return;
  }
  [...todayHabits].sort((a,b) => a.timeFrom.localeCompare(b.timeFrom)).forEach(h => {
    const isDone = completions[key]?.includes(h.id);
    const sk = isDone ? 'done-label' : getTimeStatus(h.timeFrom, h.timeTo);
    const si = statusInfo[sk];
    const streak = calcStreak(h.id);
    const card = document.createElement('div');
    card.className = 'habit-card' + (isDone ? ' done' : '');
    card.innerHTML = `
      <div class="stamp-wrap">
        <div class="stamp-bg"><span>${h.emoji}</span><div class="stamp-check">âœ“</div></div>
      </div>
      <div class="habit-info">
        <div class="habit-name">${h.name}</div>
        <div class="habit-meta">
          <span class="time-badge">ğŸ• ${h.timeFrom} ~ ${h.timeTo}</span>
          <span class="status-tag ${si.cls}">${si.txt}</span>
        </div>
        ${streak > 1 ? `<div class="streak-badge">ğŸ”¥ ${streak}ì¼ ì—°ì† ì¤‘!</div>` : ''}
      </div>
      <div class="habit-actions">
        <button class="btn-icon" onclick="event.stopPropagation();openModal(${h.id})">âœï¸</button>
        <button class="btn-icon" onclick="event.stopPropagation();deleteHabit(${h.id})">ğŸ—‘ï¸</button>
      </div>
    `;
    card.addEventListener('click', () => toggleHabit(h.id));
    list.appendChild(card);
  });
}

function toggleHabit(id) {
  const key = todayKey();
  if (!completions[key]) completions[key] = [];
  const idx = completions[key].indexOf(id);
  if (idx > -1) {
    completions[key].splice(idx, 1);
  } else {
    completions[key].push(id);
    fireBurst();
    const dow = today.getDay();
    const todayHabits = habits.filter(h => h.days.includes(dow));
    const done = todayHabits.filter(h => completions[key]?.includes(h.id)).length;
    if (done === todayHabits.length && todayHabits.length > 0) {
      setTimeout(() => showToast('ğŸŠ ëª¨ë“  ë£¨í‹´ ì™„ë£Œ! ìµœê³ ì•¼!!!'), 400);
    } else {
      showToast('ë„ì¥ ì¾…! ğŸ–Šï¸ ' + (habits.find(h=>h.id===id)?.name||''));
    }
  }
  save(); renderToday();
}

function calcStreak(id) {
  let streak = 0;
  const d = new Date(today);
  while (true) {
    if (streak > 0) d.setDate(d.getDate() - 1);
    if (completions[dateKey(d)]?.includes(id)) streak++;
    else break;
    if (streak > 999) break;
  }
  return streak;
}

function fireBurst() {
  const burst = document.createElement('div');
  burst.className = 'burst';
  document.body.appendChild(burst);
  const particles = ['ğŸŒ¸','â­','âœ¨','ğŸ’•','ğŸ€','ğŸ’«','ğŸŒŸ','ğŸ‰'];
  for (let i = 0; i < 10; i++) {
    const p = document.createElement('div');
    p.className = 'burst-p';
    const angle = (i/10)*360;
    const dist = 70 + Math.random()*60;
    const rad = angle * Math.PI / 180;
    p.textContent = particles[i % particles.length];
    p.style.cssText = `--tx:${Math.cos(rad)*dist}px;--ty:${Math.sin(rad)*dist}px;--rot:${(Math.random()-.5)*180}deg;animation-delay:${Math.random()*.08}s;animation-duration:${0.7+Math.random()*.3}s;`;
    burst.appendChild(p);
  }
  setTimeout(() => burst.remove(), 1000);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2300);
}

function renderCalendar() {
  document.getElementById('calTitle').textContent = `${calYear}ë…„ ${calMonth+1}ì›” ğŸ—“ï¸`;
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  const first = new Date(calYear, calMonth, 1).getDay();
  const dim = new Date(calYear, calMonth+1, 0).getDate();
  const dip = new Date(calYear, calMonth, 0).getDate();
  for (let i=0; i<first; i++) {
    const c = document.createElement('div'); c.className='cal-cell other-month'; c.textContent=dip-first+i+1; grid.appendChild(c);
  }
  for (let d=1; d<=dim; d++) {
    const date = new Date(calYear, calMonth, d);
    const key = dateKey(date); const dow = date.getDay();
    const dh = habits.filter(h=>h.days.includes(dow));
    const dc = dh.filter(h=>completions[key]?.includes(h.id)).length;
    const isT = key === todayKey();
    const c = document.createElement('div'); c.className='cal-cell';
    if (isT) c.classList.add('today');
    else if (dc>0&&dh.length>0) c.classList.add(dc===dh.length?'full-stamp':'has-stamp');
    c.textContent = d; grid.appendChild(c);
  }
  const rem = 7 - ((first+dim)%7);
  if (rem<7) for (let i=1;i<=rem;i++) {
    const c=document.createElement('div'); c.className='cal-cell other-month'; c.textContent=i; grid.appendChild(c);
  }
}
function calNav(dir) {
  calMonth+=dir;
  if (calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;}
  renderCalendar();
}

function renderStats() {
  let ts=0; Object.values(completions).forEach(a=>ts+=a.length);
  let ms=0; habits.forEach(h=>{const s=calcStreak(h.id);if(s>ms)ms=s;});
  const key=todayKey(); const dow=today.getDay();
  const td=habits.filter(h=>h.days.includes(dow)&&completions[key]?.includes(h.id)).length;
  document.getElementById('statTotal').textContent=ts;
  document.getElementById('statStreak').textContent=ms;
  document.getElementById('statToday').textContent=td;
  document.getElementById('statHabits').textContent=habits.length;
  const sl=document.getElementById('statHabitList'); sl.innerHTML='';
  habits.forEach(h=>{
    let possible=0,done=0;
    for(let i=0;i<30;i++){const d=new Date(today);d.setDate(d.getDate()-i);if(h.days.includes(d.getDay())){possible++;if(completions[dateKey(d)]?.includes(h.id))done++;}}
    const pct=possible?Math.round(done/possible*100):0;
    const row=document.createElement('div'); row.className='habit-stat-row';
    row.innerHTML=`<div class="s-icon">${h.emoji}</div><div class="s-info"><div class="s-name">${h.name}</div><div class="s-bar-wrap"><div class="s-bar" style="width:${pct}%"></div></div></div><div class="s-pct">${pct}%</div>`;
    sl.appendChild(row);
  });
  if(!habits.length) sl.innerHTML='<div class="empty-state"><div class="big-emoji">ğŸ“Š</div><p>ë£¨í‹´ì„ ì¶”ê°€í•˜ë©´ í†µê³„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”!</p></div>';
}

renderToday();
setInterval(() => { if(document.querySelector('.view.active')?.id==='view-today') renderToday(); }, 60000);
</script>
</body>
</html>
